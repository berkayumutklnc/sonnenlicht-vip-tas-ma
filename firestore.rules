rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() { return request.auth != null; }
    function isAdmin() {
      // Admin whitelist: create docs under admins/{uid}
      return isAuthed() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ----------------- RESERVATIONS (private, full data) -----------------
    match /reservations/{id} {
      // Admin sees everything
      allow read: if isAdmin();

      // Anyone can create a reservation, but only with safe fields
      allow create: if
        request.resource.id == request.resource.data.code &&
        request.resource.data.status == "pending" &&
        request.resource.data.acceptPolicy == true &&
        request.resource.data.acceptKvkk == true &&
        // Disallow admin-only/server-only fields from client
        !("driverName" in request.resource.data) &&
        !("driverPhone" in request.resource.data) &&
        !("plate" in request.resource.data) &&
        !("vehicleId" in request.resource.data) &&
        !("cancel" in request.resource.data);

      // Mutations only by admin
      allow update, delete: if isAdmin();
    }

    // --------------- PUBLIC MIRROR (readable by everyone) ----------------
    match /reservations_public/{id} {
      allow read: if true;

      // Allow client to create a public mirror at creation time; updates by admin only
      allow create: if
        request.resource.id == request.resource.data.code &&
        request.resource.data.status == "pending";
      allow update, delete: if isAdmin();
    }

    // -------- PNR mapping (code -> rid), read-only for public ----------
    match /pnr/{id} {
      allow read: if true;
      // Client can create mapping for its own code
      allow create: if request.resource.id == request.resource.data.rid;
      allow update, delete: if isAdmin();
    }

    // --------------------------- VEHICLES -------------------------------
    match /vehicles/{id} {
      allow read: if true;          // needed for Step3 catalog
      allow write: if isAdmin();    // only admin edits vehicles & blocks
    }

    // --------------------------- ADMINS ---------------------------------
    // You maintain a document per admin uid under admins/{uid}.
    match /admins/{uid} {
      allow read, write: if isAdmin();
    }

    // ------------------------- DEFAULT DENY -----------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
